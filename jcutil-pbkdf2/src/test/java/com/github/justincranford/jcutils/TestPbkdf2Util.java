package com.github.justincranford.jcutils;

import java.lang.reflect.Constructor;
import java.lang.reflect.Modifier;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.security.Security;
import java.util.Arrays;
import java.util.Collection;
import java.util.concurrent.TimeUnit;

import javax.crypto.Mac;
import javax.xml.bind.DatatypeConverter;

import org.bouncycastle.jce.provider.BouncyCastleProvider;
import org.junit.AfterClass;
import org.junit.Assert;
import org.junit.BeforeClass;
import org.junit.Ignore;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.junit.runners.Parameterized;
import org.junit.runners.Parameterized.Parameters;

/**
 * Mandatory tests are provided using test vectors from RFC 6070 for RFC 2898.
 * Additional tests are provided for code coverage of failure use cases.
 * Together they demonstrate how the APIs are expected to work or report errors.
 * 
 * @author cranfoj
 */
@RunWith(Parameterized.class)
//@RunWith(JUnitRunnerParallelized.class)
@SuppressWarnings({"static-method","hiding"})
public class TestPbkdf2Util {
	private static final String[] perfTestMmacAlgorithms = new String[]{"HmacSHA1", "HmacSHA224", "HmacSHA256", "HmacSHA384", "HmacSHA512"};

	private String provider;
	private int    warmups;
	private int    samples;

	public TestPbkdf2Util(final String provider, final int warmups, final int samples) {
		this.provider = provider;
		this.warmups  = warmups;
		this.samples  = samples;
	}

	@Parameters(name="{index}: {0}")	// Add parameter {0} to JUnit result label. EX: "[0: SunJCE]" and "[1: BC]"
	public static Collection<Object[]> data() {	// EX: Collection.get(0)={"SunJCE",100,10000} & Collection.get(1)={"BC",100,10000}
		final int warmups = 50;
		final int samples = 500;
		return Arrays.asList(
			new Object[][] {
				{"SunJCE",  Integer.valueOf(warmups), Integer.valueOf(samples)},
				{"BC",      Integer.valueOf(warmups), Integer.valueOf(samples)}
			}
		);
	}

	@BeforeClass
	public static void beforeClass() {
		Security.insertProviderAt(new BouncyCastleProvider(), 1);
		Timer.setLogAverageTimeUnit(TimeUnit.MILLISECONDS);
		Timer.setLogTotalTimeUnit(TimeUnit.MILLISECONDS);
		Timer.setAutoLogInterval(0);
	}

	@AfterClass
	public static void afterClass() {
		Security.removeProvider("BC");
		Timer.logAllOrderedByName(false);
		Timer.logAllOrderedByTotalTime(true);

		for (final String hmacAlgorithm : perfTestMmacAlgorithms) {
			final float totalTimeCustomSunJCE  = Timer.getTotalTime(               hmacAlgorithm + "/SunJCE");
			final float totalTimeBuiltInSunJCE = Timer.getTotalTime("PBKDF2With" + hmacAlgorithm + "/SunJCE");
			System.out.println("Custom PBKDF2 with " + hmacAlgorithm + "/SunJCE is " + (totalTimeBuiltInSunJCE/totalTimeCustomSunJCE) + "x the speed of built-in PBKDF2With" + hmacAlgorithm + "/SunJCE");
		}
		System.out.println(" ");
		for (final String hmacAlgorithm : perfTestMmacAlgorithms) {
			final float totalTimeCustomSunJCE  = Timer.getTotalTime(               hmacAlgorithm + "/SunJCE");
			final float totalTimeCustomBC = Timer.getTotalTime(               hmacAlgorithm + "/BC");
			System.out.println("Custom PBKDF2 with " + hmacAlgorithm + "/SunJCE is " + (totalTimeCustomBC/totalTimeCustomSunJCE) + "x the speed of custom PBKDF2 with " + hmacAlgorithm + "/BC");
		}
		Timer.reset();
	}

	private static void testPbkdf2Helper(final String provider, final String hash, final String password, final String salt, final int xorIterations, final int dkLen, final byte[] expectedDk) throws Exception {
		final byte[] nullSafePassword = (null==password) ? null : password.getBytes("UTF-8");
		final byte[] nullSafeSalt     = (null==salt)     ? null : salt.getBytes("UTF-8");
		final byte[] actualDk         = Pbkdf2Util.deriveKeyFromPassword(provider, hash, nullSafePassword, nullSafeSalt, xorIterations, dkLen);
		Assert.assertNotNull(actualDk);
		Assert.assertEquals(dkLen, actualDk.length);
		Assert.assertTrue("Expected DK: " + DatatypeConverter.printHexBinary(expectedDk) + ", Actual: " + DatatypeConverter.printHexBinary(actualDk), MessageDigest.isEqual(expectedDk, actualDk));	// Constant time byte array compare prevents length time attack
	}

	/**
     * https://tools.ietf.org/html/rfc6070
     * 
     *      Input:
     *        P = "password" (8 octets)
     *        S = "salt" (4 octets)
     *        c = 1
     *        dkLen = 20
     * 
     *      Output:
     *        DK = 0c 60 c8 0f 96 1f 0e 71
     *             f3 a9 b5 24 af 60 12 06
     *             2f e0 37 a6             (20 octets)
     */
	@Test
	public void testPbkdf2TestCase1() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "password";
		final String S          = "salt";
		final int    c          = 1;
		final int    dkLen      = 20;
		final byte[] expectedDK = DatatypeConverter.parseHexBinary("0c 60 c8 0f 96 1f 0e 71 f3 a9 b5 24 af 60 12 06 2f e0 37 a6".replace(" ", ""));
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	/**
     * https://tools.ietf.org/html/rfc6070
     * 
     *      Input:
     *        P = "password" (8 octets)
     *        S = "salt" (4 octets)
     *        c = 2
     *        dkLen = 20
     * 
     *      Output:
     *        DK = ea 6c 01 4d c7 2d 6f 8c
     *             cd 1e d9 2a ce 1d 41 f0
     *             d8 de 89 57             (20 octets)
     */
	@Test
	public void testPbkdf2TestCase2() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "password";
		final String S          = "salt";
		final int    c          = 2;
		final int    dkLen      = 20;
		final byte[] expectedDK = DatatypeConverter.parseHexBinary("ea 6c 01 4d c7 2d 6f 8c cd 1e d9 2a ce 1d 41 f0 d8 de 89 57".replace(" ", ""));
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	/**
     * https://tools.ietf.org/html/rfc6070
     * 
     *      Input:
     *        P = "password" (8 octets)
     *        S = "salt" (4 octets)
     *        c = 4096
     *        dkLen = 20
     * 
     *      Output:
     *        DK = 4b 00 79 01 b7 65 48 9a
     *             be ad 49 d9 26 f7 21 d0
     *             65 a4 29 c1             (20 octets)
     */
	@Test
	public void testPbkdf2TestCase3() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "password";
		final String S          = "salt";
		final int    c          = 4096;
		final int    dkLen      = 20;
		final byte[] expectedDK = DatatypeConverter.parseHexBinary("4b 00 79 01 b7 65 48 9a be ad 49 d9 26 f7 21 d0 65 a4 29 c1".replace(" ", ""));
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	/**
     * https://tools.ietf.org/html/rfc6070
     *      Input:
     *        P = "password" (8 octets)
     *        S = "salt" (4 octets)
     *        c = 16777216
     *        dkLen = 20
     * 
     *      Output:
     *        DK = ee fe 3d 61 cd 4d a4 e4
     *             e9 94 5b 3d 6b a2 15 8c
     *             26 34 e9 84             (20 octets)
     */
	@Test
	@Ignore	// very slow, re-enable for functional testing
	public void testPbkdf2TestCase4() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "password";
		final String S          = "salt";
		final int    c          = 16777216;
		final int    dkLen      = 20;
		final byte[] expectedDK = DatatypeConverter.parseHexBinary("ee fe 3d 61 cd 4d a4 e4 e9 94 5b 3d 6b a2 15 8c 26 34 e9 84".replace(" ", ""));
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	/**
     * https://tools.ietf.org/html/rfc6070
     * 
     *      Input:
     *        P = "passwordPASSWORDpassword" (24 octets)
     *        S = "saltSALTsaltSALTsaltSALTsaltSALTsalt" (36 octets)
     *        c = 4096
     *        dkLen = 25
     * 
     *      Output:
     *        DK = 3d 2e ec 4f e4 1c 84 9b
     *             80 c8 d8 36 62 c0 e4 4a
     *             8b 29 1a 96 4c f2 f0 70
     *             38                      (25 octets)
     */
	@Test
	public void testPbkdf2TestCase5() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "passwordPASSWORDpassword";
		final String S          = "saltSALTsaltSALTsaltSALTsaltSALTsalt";
		final int    c          = 4096;
		final int    dkLen      = 25;
		final byte[] expectedDK = DatatypeConverter.parseHexBinary("3d 2e ec 4f e4 1c 84 9b 80 c8 d8 36 62 c0 e4 4a 8b 29 1a 96 4c f2 f0 70 38".replace(" ", ""));
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	/**
     * https://tools.ietf.org/html/rfc6070
     *      Input:
       P = "pass\0word" (9 octets)
       S = "sa\0lt" (5 octets)
       c = 4096
       dkLen = 16

     Output:
       DK = 56 fa 6a a7 55 48 09 9d
            cc 37 d7 f0 34 25 e0 c3 (16 octets)
     */
	@Test
	public void testPbkdf2TestCase6() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "pass\0word";
		final String S          = "sa\0lt";
		final int    c          = 4096;
		final int    dkLen      = 16;
		final byte[] expectedDK = DatatypeConverter.parseHexBinary("56 fa 6a a7 55 48 09 9d cc 37 d7 f0 34 25 e0 c3".replace(" ", ""));
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	@Test
	public void testPrivateConstructor() throws Exception {
		final Constructor<?> constructor = Pbkdf2Util.class.getDeclaredConstructor();	// throws exception if zero-parameter constructor is not found
		if (!Modifier.isPrivate(constructor.getModifiers())) {
			throw new IllegalArgumentException("Constructor must be private with no parameters.");
		}
		constructor.setAccessible(true);
		constructor.newInstance();	// ASSUMPTION: Never returns null, but could throw exception. We need to execute it to rule out an exception and for code coverage reporting.
	}

	@Test(expected=NullPointerException.class)
	public void testPbkdf2NullAlgorithm() throws Exception {
		final String hash       = null;
		final String P          = "password";
		final String S          = "salt";
		final int    c          = 1;
		final int    dkLen      = 16;
		final byte[] expectedDK = null;
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	@Test(expected=NoSuchAlgorithmException.class)
	public void testPbkdf2EmptyAlgorithm() throws Exception {
		final String hash       = "";
		final String P          = "password";
		final String S          = "salt";
		final int    c          = 1;
		final int    dkLen      = 16;
		final byte[] expectedDK = null;
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	@Test(expected=IllegalArgumentException.class)
	public void testPbkdf2NullPassword() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = null;
		final String S          = "salt";
		final int    c          = 1;
		final int    dkLen      = 16;
		final byte[] expectedDK = null;
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	@Test(expected=IllegalArgumentException.class)
	public void testPbkdf2EmptyPassword() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "";
		final String S          = "salt";
		final int    c          = 1;
		final int    dkLen      = 16;
		final byte[] expectedDK = null;
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	@Test(expected=IllegalArgumentException.class)
	public void testPbkdf2NullSalt() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "password";
		final String S          = null;
		final int    c          = 1;
		final int    dkLen      = 16;
		final byte[] expectedDK = null;
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	@Test(expected=IllegalArgumentException.class)
	public void testPbkdf2EmptySalt() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "password";
		final String S          = "";
		final int    c          = 1;
		final int    dkLen      = 16;
		final byte[] expectedDK = null;
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	@Test(expected=IllegalArgumentException.class)
	public void testPbkdf2NegativeCount() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "password";
		final String S          = "salt";
		final int    c          = -1;
		final int    dkLen      = 16;
		final byte[] expectedDK = null;
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	@Test(expected=IllegalArgumentException.class)
	public void testPbkdf2ZeroCount() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "password";
		final String S          = "salt";
		final int    c          = 0;
		final int    dkLen      = 16;
		final byte[] expectedDK = null;
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	@Test
	public void testPbkdf2MinSaltLengthAndMinCount() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "password";
		final String S          = "salt";
		final int    c          = 1;
		final int    dkLen      = 16;
		final byte[] expectedDK = DatatypeConverter.parseHexBinary("0C60C80F961F0E71F3A9B524AF601206");
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	@Ignore
	@Test
	public void testPbkdf2MaxCountPlusOne() throws Exception {	// NOSONAR Fix or remove this skipped unit test
		// No max count specified in RFC
	}

	@Ignore
	@Test
	public void testPbkdf2LargeCount() throws Exception {	// NOSONAR Fix or remove this skipped unit test
		// No need to repeat since RFC 6070 test vector includes a 16M count example
	}

	@Test(expected=IllegalArgumentException.class)
	public void testPbkdf2NegativeLength() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "password";
		final String S          = "salt";
		final int    c          = 1;
		final int    dkLen      = -1;
		final byte[] expectedDK = null;
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	@Test(expected=IllegalArgumentException.class)
	public void testPbkdf2ZeroLength() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "password";
		final String S          = "salt";
		final int    c          = 1;
		final int    dkLen      = -1;
		final byte[] expectedDK = null;
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	@Test
	public void testPbkdf2MaxLength() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "password";
		final String S          = "salt";
		final int    c          = 1;
		final int    dkLen      = Pbkdf2Util.MAX_PBKDF2_DKLEN;
		final byte[] expectedDK = DatatypeConverter.parseHexBinary("0C60C80F961F0E71F3A9B524AF6012062FE037A6E0F0EB94FE8FC46BDC637164AC2E7A8E3F9D2E83ACE57E0D50E5E1071367C179BC86C767FC3F78DDB561363FC692BA406D1301E42BCCCC3C520D06751D78B80C3DB926B16FFA3395BD697C647F280B51F0AACB3AC1A467219DACAD4C7341DFDD160D1ED8E13B668009A50C9B69BA29E1B2CC7C46F90083CCC9D9F9A5C7B35F663F8A93460C45AC371E665D803C82AA2EE5E11E7FFDD46DEE3F671D00009E3510DA76327245FF1C77A22585C89616691EED497276C3CF1C56BA6925D5C6AB452F4269F9E95501C53E74758B26E6097004B665F8AD9E89F2792A4CE36B3AAED879B7006CACD9A4FD08BEA05D8C543412E7762C9EA405F804598B18FCFC7B0428F2A4351369EB5D9324996862F5060A033A8E62F150798A4489F9BC6B1190EF994B8D96B69C7BAABD6101BF8C243011A335F6210EB66ABEABC5826E5D5874EA4F4D3D5BC87E4D98DE95001067971CCE6A142E31207193CB8607D53AF5325D2E95D620ED42DA15FB001ACBBB255DB1AB75FCEB3DB5FFB500E6D023DAD7A8770DAB32C435C51E46EB4D0F32B1E8F2D5704FE195F454E7E1163136AFDBD4C16CB4812CA2E14079679496E6E9CE78FC58DD6865D1E964D4811D98D588DA33989E2B5B5190970E96A83C697C23B0FC2D69622CF6C1E29E51A850519F4BF7AF6939962C72AB40C37A079A09E15E929F212C3E8934FCBA2A79B7371AB8F4F58A93BCA74BC65B62A1A131ACA8CD6001211AA5B09FFB6CA20F2629B2847F9E00C68EC1C5067E431E2F0B0400968A749FD72DB966C5215DEF9859A26340EF9E6B7BCDBD8C12EC0B517C276300B69E7FE1D813811821001C4154A0B1FB8ADD7D2EFB4EC925323AC3E087E582167A5227BCF08221E3D88E6A79BAEE5EFF0D5820DEF003D99D58A8DE3229CD59370813E891EAC965CAA1C48914765676FB59A0FA2D073F36404347AF65E0C1976BF9DF17907360A884AD641BD90BFB0B8C350DB0D67C172F3497CB9DF4A0E05CC30EE7E41CADD55B863C6280F70805F5C6D185CCC10BD6C6D8BAFECD1BE6C8E2BF647ACD8ABE67972CA81F15C9664485165E757DD3C4A298A0C29EAF8D9D69373E6B9C5D136959BAE067DA08C83BD0C8978A6C6AE0B4E7046E75F63D700669165EDA3F24323AD08C16D0BF3763F151CCC747DCF2B04ED935497CCF1B81F8D134C4FA0F45DCA26D5C6A8A0E813A1715B1E0838C10748EEF5D9F3E0546B97804F173E0CD4E229FF1875ECDE6DFC0857A2FD374AD117FC48A4ABCCE3FEC8F1D76F56C4FDAD232CD770201574930DC2A40E3D3497AF046513B78654B4C9D017F6A74BD70A040D7A197EDE0FB6FFB28725A9637BD15F79D4B4A7DAF8377E43035F4BAFADAE8BECEFDC8E8D2A6CD5D25E52CBE2D4A1A88EC051B15DDBD30793FEB6C3B983078A174012816333895DE530144B2900F121B430C2C9AF439A3E055A52A2E2578FFC8C6153A277419E0357B730E31EE93B07320D087D0237EAB8B9B838258F34F7A6A925F776ADCD363B335EA8C43ED7E9D202FA2451B233332C4B08BFC5487E96D0EDDEBC75E87CED131CF63ED55A45F35C20DC10C092A52F846DB379F8C68101675639A49DE664090DC2F068D051FF7F9F3D796A805375157AAB4E9B891842DFC9142BDDC753E5BFFA484867AB8F31C307C05D71EDC57EC61CB32F267F4EE6D9AA2E1524D68253652A5BE6A525D803B0DB7F1CD2EB78C71E93F49FEC2D3F26DC564099F20233BF2C223F1A55122158C55B8A9CD0744FA86F70A2D80F133B68424875F15996E7505C1B9CFF965F16D3CC54078FF2BB37A14668433DB32E819294DB91BB4084445AA80C60C6AAE1F54C7B04BDD2F320B868A08D0673A50B83C2CE8954693A64472AB78A0E2F17B68545A20A3A43045A23B10C5B7340C4C01619427CC7E9CA37DC199854172D4069DB6F419809E781FE8D90CA0E66EB7F1BFB3EE4ADFF4BD99C8E4F519E23E5DA3DFB1D4C31C69ED2D9DB948FE99B10004007C14F5B114D633E659C45844B32D4EDC34D21A355EA81159D505491D17BC2E322E1758D2E14640393DB0B901DC7E381BD19DE34E9B156103C7EA6E1ADA36A368FBE9D881ADB7D61A73E2607180807D944FC14DDAB56C0932266CC343CDAAE738CF918576FFDC985EA9AE138AA02534100805CB551679DA872D84AF5BFE8F92C8989F4E3680E25EA6B4077C2B99BAD52AD8AF6D635A903DA550F7B14FAC2B168B2119DBE65ECFEAB90A8E16EB4BC30FD57851AF0854CEA42DD6B9ACDF1AE3B2E94D143D9D021AB39D26442AD4BE82B6C95B4CE889C64BD6119DC8224FB6FAEB63D4B0F0F656F81440FCBD3C617816DAC416A359CA7B6B972CF0A5F6BC205DCE10AA183A75CCB199E59307AECF2C43CF81FFEC9592080DB9F4D8A43C4E5C26D72CA2EF32AD72BB8AC6AF149FAB200AB980C48E13043938ED2B74395E6DC5FBB79A797F6ED88043B31A81F4C79457B42D35CB83CF2E3707CB3CAC1C7CF9C82F16C0D0B7A04279AD7643E68F48AE0CA24E672FD65B9A55BBA33294B7235724571DBD30A796CF40E0BAE316B3966578ED7364DD05402AC95F912A12AB66EB1B18C07E04094441473DB7226071F3ED8307C1A411A91A6E6ED0E04ABC692BDD043AA35043C4CFE816A85CBD6839C2B82942F0D1D9F1E26AF656463CE92E5372D64176F833E79966A8EA47BC38BEAD35519EAC3D05DF04C51E525F5224B435B1DA033ED36AB7E4071F3C0BA82ABBB43A85215A5706D36FEE47D30C9D94FA54728CF0BAEB10BA8D8755D3A4DD20583CF00E1D0347029C4910BBF8AA7240AFF79E3122D11EF9BB17EF337514A8E6008E59C75B86D71923EB8961BE92A2E2BD04033C032307BFA5E6ED3AB03877FA58CEB9D25B8DF339748981A41745C761BB7C80062804A4F0CEEA822E3A192A06AE39189886EC6FF7C4D03DB8DD7B9B1F9B3227A809F408DB0EB7E30EB4AF52C768C9C0D90F2C94108335C3EC11C96058D607997A37691A1F8540CD60E0F9D65DA85877A862A2A8BBC6C4C3DF712A350031CB530BA9E28776E7B7B8FB6B7C87263A6739C99873FA859131359A958602E4CA659C47C3A9EFC8F3A8E81E6FBE96C5178387FBF9592EB937FFFAE408CA3E0290EACE5EF749C80B10D8E88B45D4553F6D9E9BF71DFCA8A52ABBC3F793026CC7C6E7B84474A5AF55189A6B60217FC67B8D29015871DDA348196F618EEBB647E5262449AF181A5420F1DAB6C871E3B2C7CD05EB5AADF48B5E2B9E661052E27AF5473A9985605172315DAA0C4C518A7231ADDED236C26A921342E33A9146DF4641135E69B6B18F14BFDDA260A640358256736803C87CF19C4556E1D06EC247875AE7B301383DEE958BCAB1DE46888829B4D5EB4EA7725BBC22017AC2238B174541D398141E6C15BE6AC0BE5A14C6E68F614A66416A48AC140F03D91F348AA8A5546D22B720D25225FC3FFBF2FA082B9174784AAAF6A483B824384270CA3FB30CAFE502FC075C4647259F846BF1264E6D554D4742410303995654FC16484F4F76C9C49D3D9343564A7EBC2873EBF99FA886BD77A6D8B89860E22A94C5B72194811CEA5FF618E5C5001F187057812882DE7392496E6F7A70AF01C5F9025BDB7E6FF6559AEADB73F0506A8C08B01E13D5001B184B85E924FE02B5FD427725B72C3034E61F2B71DA32C47CF83499EF1512934CE3D91FEFFA9817A17CBBCE50EF613DD744B8889160A72FEA1A63C54DB0A3DE88BADD62B60E404951E3BFDEB9FDA9B5512AFF92627B235FF50966311A4BCE944CD219FBC5BB707CD1DBD58AA4A94C19A5F19A93E2F4A0FC8850C7CBD112B94C5DBE79EF87660B71D5B3B1628450B01C40E5B58B88FA9ED32F78996B1398BFEE71F2E173D246EEB277C0CF29CB2DCB0393ADCB554A3EDA274EA33AB8365AC6E6A2171DBB0169B6A8ADEA8F7D02DFCF0CCBFF89E69E79E5E31A32660EC03B80D0AEEBD2732073140EEC25E7084F6C5639C6B3C9106086634EA636203BFD5F9D19755373696306D5432FE7435179F6980EDB5582071D42941A6DE256CEBDF46A9B77C552DCBD25374624230E9F59C20B50569BA4B99A60056AACB8FD68E0E2E7D7F61B367E89024F6DC0ACFF6B5FB0B472D506209249E1C47FFBC443663A8D0959A22F776F872E34A6EF64CE89690E4AFB241F52999CE2B267BF5054D288CA789F7B89522E2C293A9E8C63609896CE52B617959B951E25FA6EAD75C9390758A846FFBE7D467EE659C6DFC907A629B5764378C30A725CE608E5B581AC905096AD2553E5AAB992F76283F5D585487126863DC3926E58F7996200F748AB82C4C69D5BE1C92EF53A76F7325A5E7A271D4D15E96B474A4A7650DA46E39664647EB49DFB408D36998102BED173D25B24C3BD2A635317DAEE6A47AABB3870F805250F3D8273BBC173C6AF7FAE520188A07D401AE678F40F90679B53B5C734C86B984F159931217FEB3080A85433B6092DBF4E24B18F4BA705C2FAF5F424C83B4788BAFE2FA0E861CEE4E678314955D502193BDE04CADB7923B005C162CA4F4A28AA43BB8F55D40615A198C2424FA101683A2CDC0AC7D4BC1F2D348FEC066D67E010855922BC609C65456C55DAA1443A37318BE94B2072C4BF9E9399D52557AB41B862A6047D573AB69E805DDFDC5BC34F4BFFD10F14E4194AA3946C405E62BD7275AD8669998E1EE66AD1E55F3C3097B8C05C6F843CA74F46595FC5EBA9CAFE01EAC262D9DE73139AAACE736BC2570AD97BC2530CF72F29A58731D4DC8F91C3C698AA7440B3FE6A1F7B9A7BF9E35A35152CA065AB7980B79E9EE5D45333642ED815658FA0679E258C2D00355B7A31BD17D1F107BB1DCA4860361AB5D237B8985E47968F1B0E54F44477E513CC9FF2EAF60D02E54476B322817418AFCE684CB46C64B07A409882DF9B0D25BA2FD94671D83220EC8E6F06E507E41008AAC27857D0BEBE2089A85FDB369B291B30E272E92C900D9AF9C55272310111788E062CC9A8A4A71C358E0D8663507F43BF024D9D34B9C90F2F3ACA8618AA1C8B038AB2D5CD09CF10F44CBF22E6B4CEBCC9E70F80381CE5F1C0BB34F68D8B56DD93E945AA36890C278EB25A8FE51AD04CC4D8398678781EB20FC3B55D90464D050FDDDE59E683816FC5F5043342EBDA3FDC8890E04EADEE3C575B10B4CCB6E105535540C4393948BA8F9C1111CC0584C8162D1542EC548637750F42516403003D65B4FFE4E2E139E424A508FE9797302219EF6BFAFD6B607CBFBE5D6D7AF9A382A1A0CA75154B95709158D8FC4EDC9B4443768683C013F129DD01FB0D55B6B1FEFDA654369E9FE182FD02CDB044BBE8402DD7B50013C8421B75BBD749572174C16FA0E5D0B6515E28938A0E81AAE85AFE80125419A4E5BF1C3BC4F5BC89071A87922FD09F24C84615637C7A4C46D47C9E6439C39EDBCE31F269ADB5C60484EEAB3D26018B1AE4C14820FF990DA2E3F3C946CD7250E151260DFEA39522ECDFD79311E8E6E8E6410459323EDB0350C2660D245EA5D425E4F1AD6A0810668DE888DFE20530C434CD2DB934D700711AD1CD358BCCF3BD1FD0C549A5B32ABA610CFC53A37E99068C777332084C7B8BAA29C2AA0C50E1DFBA735FA01247240312A7DF4394EE1D1672E7F4B7EF82908EA8B0A26F1B8D75ED304664D9B364DC7948AA0872E92F9A48786E4801C7AB6950AEE478E6573F9F78F582990568B02109DD5339D2DB7939565DE08239E089E58CA2D20AE420512FD90979E96A3CFF402EE18E5CFC22CD7BCBBA09ACDF9CC734FDB1339A0D8B12C749A8324EE690D0770CE41B5400BC940881E68948B003A07FEDE15261F45210FE6E4B5336A38163DAD630FDCFAAEC1A1723688584438211E47802CDD86EE7898910137D36F312ED3963F3C35E2CF891F67D116E6415FFF99A15E8D0D79D654786A1A4DF7BA4486961FD7F67A6705588846D4F474C400162ACECAB66800A1EDCCA2E22865D78930D7C28729BCA97A449A45DC3C28FF5B0D4B58B439762E11CE40883BD62EDE9FE8FB08D0D02F44A029E23292710452BD0E765F41E732705B2217A861A469FACC368FB7E27D731438D3838B9974F5701E65C37B7EB5B9F58F46B3D834640ECEEBE9EFFACEB0B0F664D8CFFED695A211A5CCA9BB1455DB457FF645472B127A61D238E5BE34E0ECFA30443854EBC46FFA667BE7DB3A54CC121A75FCEC86DA0CB14050E88A68C14D6819E916EA5611C358638863F4763D455035C2C0E38402DD25746428F061844750F68230828E09AB4C02B54ECE91315D8E764D0046E3A469E5FD3BBAAC8120668987FD163262A61111563E3A44ED913AB94943452ABA42F5BC16B4986496FC2B6F62AEAFC5C6F825068DD2C32DAD3687E4560CAA4E3F8C75C77F78C78E43211CC67E3832EC07DE6A374C7A959CAED585BD894FCB7FEB3D64918E44AE81868698BB3AA7E1198C74148090957FEEDB6F18565EDCD3A6A12C628412BADA001D563CDC8167F096A585E2AE0A39904EFD14122262A1849E2421CF8399865324FE1F3240F39C69376F9356C85733D92AE4A4316C46FC21E54C42487F26715C65A01BACFC8D3B5A887DD1D923648437DCD1B81A0EAEBAD542F883133FDE8863725FA758719F477C8C90C874256E732B288AE5A2F02BDF76C537C51C7177AB0F666E82B948F6F55467A111E2AE75B23A40B774D2AFEDA9B7014F4CB43510C3F7BE6726D98092ABD1E4B7DB8EE55732C0F6500C95CDAE061B398BC2FB4CD5459E76498389E0B9035A113584812AAA8428522A81CFB4ABFD959ECE6457FCC8DC133A521D65ED6CB22AA8ACA7EE9BD309AF29AE8EE9D7238D6180500A6B8A24812426C0EA58902C50626551E249A3801477FA0365FAB04A1358CF962FB19FD5621CB9CC3BB0103232484030BA2C2958599FAF292B4BBF9243B2242B88EDCFEEFA9EEF5597FF64E8B97D12257568B8F062CA5286E4B3EA25BE7C472ADA869C3EF9D92A9C1F1181FFEF5E4B349DAF28D774D2E4732C9F913C9CBC03E49279CFC580649A11749187AAB51131DA4391B2A5AAE79A2ACD73C409B5E158BEEBE796FB3D8A554E76837FBBACBB5915F613A23D3B8E19C4AB8AD011836D56595518351EC9071BF3765B991AD332DD8714D19F721E3E2F242DD87D6166894220CF9328139944BB7546E67995FD7EA5FA9A3F01CB3068E4BC48D8F15D5918FB389B0537AA21739E7B940A64B6420BFDE6ECE34ED355003B2CBAAC5875E03C8D6014D6AE93D9607EA1E1A7A4C8B21CF080515C2A1A42C02FCE5510633CAFD78C9EAD6FF2AFB833AEA34AAEAC90FE586BAA60682EC7C3E8CD0A2B451E29B5451E7786AE6974F09ED17E08007352A481EEAD16820F7A32AA2A550A67BE47C1B3E29DB0119F4DF6DF8D844C84D44E32920F427C1622180AFFA94BAE4D6A1A8C868343BB9BBC5524C128FF48048D54EEEF2450496DDCE14F0AFA18ECEC3E65A5B8D5DB5BE13661B5738DA06CC414C53E2B23601402AAB4EDE6BF4A1A17E5B3160CFEF28CFF0345CC25FF222CE8066E4225B0C6531E47319259A9DD332F7C633FDB12530E3690B8B43261DEB31C9E0F65A19F22A7C521D99E8BC0BFCAB98D0EBDE0CA3DCBD57351688C5810700DD051217382640020D64451BCCE6420E66578A4CFB83B333EC86A23266CE0F6C53A1A9BD6A80C359E84F1B398FE4E24F265E6EE42A45AC5AC495BDFCFF525800F7304CA76B983F36E212771618D58026CCAE5D4627B782FC1DB3DB6360F0BE69BEBFC187F010A8DF8DC667D2A969582D2AD38CCFDEFC77F730827E41780F41C716A9828F5F0096769B57371C42CB80AFB1DAFE52DF3DC6F21D2562DF1CAE21EA1889AA983C99E320D9A5A246BD44DACC4A5E74C90DF88E0BAB80FDA23907F29B3D6EA92D00793D599D4FA9F36F2EF6732268A711F3FE3806893D709A8E1C32D7A0126DD7D768C0440066D219CEE617AE3A6FE8054B13280C925B96CCF45E03629C2078C3DB7EF3A4E1426C3869C1FE04A62209EAC46306E5808F135E79D74F4E8C42E03B69ED1BF24FF7075DAE00F09A410B6B2AF9AC1E14B432F03430DEB8FDB8DA28ABD1130295FB3AAC50D24E1247A2B5F4133195BBE5D04364280AEDDFE0FD21F05E086E00CAA909EC93F1C905CECC23D32C38F1999500ADF0978BD2814793319BA4C6B6041CB820D9C401F72412D8017C3D0CE9158B5D4D177D1F441F5A207836D805826D153F6925A5036564A8575F4F2BBFB3747C3AD69DD53A9E2A6B29A5B56BCDA2E7A32EBFCAE062128DC96FDF11C4A6A529297FAEDE9EBC706CB168D5C3E279AD21FADAEC652DAA3149A023C90A7E6579671286056B0431A3B2271DD73BB39C29AD4760462A99C337BD715887F8153EE975BC1DCCA3C2C7B000D8A992A6B127260512B91CCB52D020C72717DF45A411B20749BC168D3C3EAA5A379402F926A8CC387FD724F7FFD65A75373C03975EC6580C8B95DF08D4741198392513D5A6AA73E582BF6844218A02DC3B150145E8D46E9152FC1608F5142CCE0FDC44F58DFFEDE518E2F549D1E8948FB4B715990C7BE9A5FF428E89A5FA7C768DD5C5F6449B33051378AD45DBEF06A283B6702B3DC813EF7A071AAA2B906BAB6C73FCBFE521289D8304D17A9FD95F322C0CE7CA1424704BAFEC7530B266AE85F09F9A1DE78C3BDA0CBDC12C8C10C127BB409A986E95F7DA76AB860B7C8FDE3242787D895D83145556C8464E8D31728913BCB334D893D87D368254AD0AA021F21F99F9504F96B82FB9BF2EF50B6A6F97F59B312EE55759E83092796743C8B1B7FC133DDAF3ACD04A1CA84DF972183794C82123E2F946DA6F9463E70EC276B7C95218429A72607B724A4B53A75ECC85E7944BB7DBF6D50A1FDE1053B99D6F03C24762CEC4ADDA21F196CFFA60DB2DF9F3A17B5036E257C9EC749AB1EBC7896BE6918D572D0F8A90CAB7028785D41440035A332AF012DFB10FDC838ADCBDA9212DA53862A2B1F8882DBA03AC795EE20B2462001A27BC0A7C170679E0859E7B3D1A0054DAE62690D355B098BDC225321A60C986E7CF30B03BF50E76F39C15BC8D3AA5BF0CF07B4E5744DD240E6DB5D42AC59FDA09D93E631FC243EAAA0E0DDDC787D1E6057A04F3F0C7582814EA452CCDC4D9EA5FE4D42ED6565EA89E811EB4E6E3A38F6CE9C2281EA4E35A3FAF7E431C7DC55D0864DA4C7484D7CFFE7A44D69DF710B3B04F032C7981117116ABDDA428DD9F7E88D346290AB0D841031FB35AFB0F0A5C0486250F8D6CC3DCAF81E797E132A3566C715E2BE2B67309BC03A1F5CB9DB4E4C8D49BFDB10F2172AB978F4CB3FC5F02D4C1CDBD609213A6A25C80EB626756A4C825CD547D40D5EA5C59A9441B84701B0F2A81BF4453583E2356C2DC63F2C83D0926C857ACE6F6BF87CD004AD5E79752CCA1A6565B55D851938DF6B7AC4528CA5B70019130B2559E96349D241ADC8F2D79A775C333760D6B907DF2F0EEDF24826B0F2D9334EE49A26D08BBFA7EE0F52BF6A90E6F47E0157EA1761DFD413458C7B3CDBC5A48A19F607347D76F617B290013E7CBFF10039580F0E222BE3C5CF07D5C0A877F0159AE9E4C681589E4F75445E9BE46BBB564536AE64183B4229ED9B9F87358CBC21AC419F604E9B3E4C4ABEC7AB501422085661E75F2C2FF408DD17A634DE42A24B52DFA163B689DB3D28E8EDF838FBF1A8D0EEC6A10FAA9CDB5003EF93CDD411194B424B19511E745615ADFFB9DAAE904D4C57E1D06911A2D64D2A62DF053C44A799299F866CA618757FFA6CE0E608FA39BD1870C3C55DCFCAA9C9F4F11417D6966E806EF913F3BC2D61F970ABCF72B34B5F305875DDF2A7E8B7D8F3A8C31E12BAC1C514A4F2B8827DEF4A2A8A996CFD4E1E2770F9B3AEAF5D697204C04D46D7DA5C86F0A3F21DAB48587858B897D3F698EF988BED403A193C0D84001E0410323E9A9B9DC07B4B16F7C6D291CABF2E15CC702FFA0051920D32F656D702AA2F8E8822762762336C61578E8CFCCB84112AB93F4DE63128F7ADE30A7F730E61FFFD2A26492263DD12971DAF7E40B28154EA41D0771C6ACD4B5BDFFB3A16B7A2B33000D5252838D85EA918FCB21DAE8712D33848C904113715F4B91AEF0E407F5D9CF6326B1B5CCD8B30A50DD646E3DB6D81ECD5B84AE78044F36AA904565220C709F5B1EA5A10F50A7287F97B2859F48F521C0DE59465DB6E39DC710BEAE710A272CAA18B2D3799EF41B1AC8E8699B19BACFFB95DAA2E025843B9F24FD383089960A09391DDAD7DA1F02FBC76BB1D3F8C78B30B1EA77A6281F09B93A0F5CCD447817C66D25F6EC2B93519F15D121F2055170740BA1B1FC0486A90D3C5AD1189D10F00AC1CC2EA05CC41772A19DF1EC6D3D4496953540A6A281CE78521AF4AC724E8B1A28D8C8D821C524A0CCB7C02FD5DD3D32BF0CC06B4E524202991F741DA8BAD9DE144B0F63191A8BDF35A8F655B0D4C17B475A829AB225B68B652DDDEE185960BC1E2470099D88607B37566978DC40D2AC0C1DC77FE1CAEAF0F5463E22276B15A15A279181F62B30C9B77A437D53128026411D1E1E83C254F87DE6BA3689651D84FACDC3AC7544B6B7B179DC04BB94CCD4E28D2CD6BA30FDFBEB743E40BEBEA977FAF1C187242111BB7234F89BF11D386BA75F9A2860D170DBAD48E179377F45425D96AC79C6E02BACC76BC131723308753AAF8571AF861318B4157B7C428E6B0AC4D856C522AA534078E958B6F49A5BD1030E2FD4C4D063B8871546BC37334DE0061DB40BED91D4AE11B0EE5A38750E712ACD701D158723FBDBD8DAD043FECFF0724F55B2F155EC17959A6F2362D3D44DC84ECD7EC7DD891EC2644B9468D41219DFED1D693C0285C99670B2143A0BA8100CE4CD6925FEF2B05F44D4249EFC6576C0D430C019EEDE6AB2D8444C7E6BF5A001FF9E742C7718105CD5617165A0F34356D9926C6E30DC464173E7A9B4921556E15583A963741F44A0262218DB53936475435BFF427C6E8D73A03D91A5BFE2327456E5A51E379D055D9548F818F51CCC93AA257747E97E07CC53784F31DEF5AF3A5B448D518C4249868A925CF3A56414C3B27FCDA6B5EF7B0ECEC3274C03F0808C8CBCA43A5332F4D1606A6B382F30B6E2A3952D47E42D4E5E8A9C9A3BEC4A6FDEEEAAF69EBF5291CD144B333A4C214394CAAA3D1F95C700D4732DB58E601CB968616B062B17FFE97FC827CC147C1F562FE8B22245720C9E505449076B5ACF9C3A18A4C8365775CD39953F0D078D3AF654E46707A1F2A9EA2DC48FCBD37A7E7B5387531EFC545A2AF943D7ED298C8B6433CD29A0385C603857C7967AA9526E7B1A3ACC140F5710201113A90502942A1D5B642E9EA41787294DA4F9B8D5FCF6A8F632F984D3E2AFEEE9C021D9F1C7EEC68B38DE9C70AB287F4C574104D7E64DED4460D1B92CAD115582073D7874065831DEEB85FAF05D66CD01C96A35C02473029721160A294F23C453734659AE6C40B25960070572E4CD816F0DBCB602C3FE6928E1774E814A29A5591666E8197A97373B4EE7E08AB31B5970C25C5CD9637895F751841F252B60B720701C91F67FB3A60BFB34");
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	@Test(expected=IllegalArgumentException.class)
	public void testPbkdf2MaxLengthPlusOne() throws Exception {
		final String hash       = "HmacSHA1";
		final String P          = "password";
		final String S          = "salt";
		final int    c          = 1;
		final int    dkLen      = Pbkdf2Util.MAX_PBKDF2_DKLEN + 1;
		final byte[] expectedDK = null;
		TestPbkdf2Util.testPbkdf2Helper(this.provider, hash, P, S, c, dkLen, expectedDK);
	}

	@Test
	public void testPbkdf2Performance() throws Exception {
		final String P          = "passwordPASSWORDpassword";
		final String S          = "saltSALTsaltSALTsaltSALTsaltSALTsalt";
		final int    c          = 32;
		final int    dkBlocks   = 8;

		for (final String hmacAlgorithm : perfTestMmacAlgorithms) {
			final int dkLen = dkBlocks * Mac.getInstance(hmacAlgorithm).getMacLength();	// SHA1: 20 bytes, SHA256: 32 bytes, SHA512: 64 bytes, 
			this.helpTestPbkdf2PerformanceDeriveKeyFromPasswordCustom			("SunJCE",                 hmacAlgorithm, P.getBytes("UTF-8"), S.getBytes("UTF-8"), c, dkLen);	// faster than Sun PBKDF2With*
			this.helpTestPbkdf2PerformanceDeriveKeyFromPasswordCustom			("BC",                     hmacAlgorithm, P.getBytes("UTF-8"), S.getBytes("UTF-8"), c, dkLen);	// slower than BC  PBKDF2With*
			this.helpTestPbkdf2PerformanceDeriveKeyFromPasswordBuiltInSunJCE	("SunJCE",  "PBKDF2With" + hmacAlgorithm, P,                   S.getBytes("UTF-8"), c, dkLen);	// slowest
			this.helpTestPbkdf2PerformanceDeriveKeyFromPasswordBuiltInSunJCE	("BC",      "PBKDF2With" + hmacAlgorithm, P,                   S.getBytes("UTF-8"), c, dkLen);	// fastest
		}
	}

	private void helpTestPbkdf2PerformanceDeriveKeyFromPasswordCustom(final String provider, final String algorithm, final byte[] Pbytes, final byte[] Sbytes, final int c, final int dkLen) throws Exception {
		for (int i=0; i<this.warmups; i++) {
			Pbkdf2Util.deriveKeyFromPassword(provider, algorithm, Pbytes, Sbytes, c, dkLen);
		}
		try (Timer x = new Timer(algorithm + "/" + provider)) {	// BC or SunJCE
			for (int i=0; i<this.samples; i++) {
				Pbkdf2Util.deriveKeyFromPassword(provider, algorithm, Pbytes, Sbytes, c, dkLen);
			}
		}
	}

	private void helpTestPbkdf2PerformanceDeriveKeyFromPasswordBuiltInSunJCE(final String provider, final String algorithm, final String P, final byte[] Sbytes, final int c, final int dkLen) throws Exception {
		for (int i=0; i<this.warmups; i++) {
			Pbkdf2Util.deriveKeyFromPasswordBuiltIn(provider, algorithm, P.toCharArray(), Sbytes, c, dkLen * 8);
		}
		try (Timer x = new Timer(algorithm + "/" + provider)) {	// BC or SunJCE
			for (int i=0; i<this.samples; i++) {
				Pbkdf2Util.deriveKeyFromPasswordBuiltIn(provider, algorithm, P.toCharArray(), Sbytes, c, dkLen * 8);
			}
		}
	}
}